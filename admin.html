<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Picnic Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            background-attachment: fixed;
            color: #333;
            padding: 16px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .page-title {
            color: #ffffff;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            letter-spacing: -0.5px;
        }

        .back-button {
            display: inline-block;
            padding: 10px 24px;
            background: white;
            color: #ff6b6b;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.938rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .admin-card {
            background-color: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            margin-bottom: 24px;
        }

        .admin-card h2 {
            color: #1a202c;
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 3px solid #ff6b6b;
            padding-bottom: 0.75rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            letter-spacing: 0.3px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b6b;
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.15);
            transform: translateY(-1px);
        }

        .form-group input[readonly] {
            background-color: #f9fafb;
            cursor: pointer;
        }

        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            margin-left: 10px;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .map-container {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            margin: 16px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .current-data {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #10b981;
        }

        .current-data h3 {
            color: #10b981;
            font-size: 0.875rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .current-data p {
            color: #6b7280;
            font-size: 0.875rem;
            margin: 0.5rem 0;
        }

        .current-data strong {
            color: #374151;
        }

        .info-box {
            background: #dbeafe;
            border-left: 4px solid #3b82f6;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .info-box p {
            color: #1e40af;
            font-size: 0.875rem;
            margin: 0;
        }

        /* Participants table */
        .participants-card h2 {
            border-bottom-color: #667eea;
        }

        .participants-table-wrapper {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table.participants-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        table.participants-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        table.participants-table th,
        table.participants-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        table.participants-table tbody tr:hover {
            background: #f3f4f6;
        }

        .paid-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            background: #10b981;
            color: #fff;
        }

        .unpaid-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            background: #ef4444;
            color: #fff;
        }

        .switch-cell {
            text-align: center;
        }

        /* Toggle switch */
        .pay-switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .pay-switch input {
            display: none;
        }

        .pay-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #ef4444;
            transition: .3s;
            border-radius: 24px;
        }

        .pay-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            top: 3px;
            background: #fff;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        }

        .pay-switch input:checked+.pay-slider {
            background: #10b981;
        }

        .pay-switch input:checked+.pay-slider:before {
            transform: translateX(22px);
        }

        .totals-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .totals-box {
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            padding: 1rem;
            border-radius: 12px;
            border-left: 5px solid #ff6b6b;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .totals-box h3 {
            margin: 0 0 6px;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6b7280;
        }

        .totals-box .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }

            .page-title {
                font-size: 2rem;
            }

            .admin-card {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .btn-secondary {
                margin-left: 0;
                margin-top: 10px;
                display: block;
                width: 100%;
            }
        }

        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 107, 107, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(10px);
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="loader"></div>
        <div class="loading-text">Loading Admin Panel...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1 class="page-title">‚öôÔ∏è Admin Panel</h1>
            <a href="index.html" class="back-button">‚Üê Back to Main Page</a>
        </div>

        <div class="info-box">
            <p>‚ÑπÔ∏è This table contains a single row with core picnic configuration. Updates will modify the existing
                record.</p>
        </div>

        <div class="admin-card">
            <h2>üöÄ Bus Source Point</h2>

            <div id="currentData" class="current-data" style="display: none;">
                <h3>Current Configuration</h3>
                <p><strong>Bus Source Name:</strong> <span id="currentBusSourceName">-</span></p>
                <p><strong>Bus Source Coordinates:</strong> <span id="currentBusSourceCoords">-</span></p>
                <p><strong>Picnic Spot Name:</strong> <span id="currentPicnicSpotName">-</span></p>
                <p><strong>Picnic Spot Coordinates:</strong> <span id="currentPicnicSpotCoords">-</span></p>
                <p><strong>Price Per Person:</strong> ‚Çπ<span id="currentPrice">-</span></p>
            </div>

            <form id="adminForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="busSourceName">Bus Source Name</label>
                        <input type="text" id="busSourceName" placeholder="e.g., TCS Office Salt Lake" required>
                    </div>

                    <div class="form-group">
                        <label for="busSourceCoords">Bus Source Coordinates</label>
                        <input type="text" id="busSourceCoords" placeholder="Click on map to set" readonly required>
                    </div>

                    <div class="form-group">
                        <label for="picnicSpotName">Picnic Spot Name</label>
                        <input type="text" id="picnicSpotName" placeholder="e.g., Debdwar Park" required>
                    </div>

                    <div class="form-group">
                        <label for="picnicSpotCoords">Picnic Spot Coordinates</label>
                        <input type="text" id="picnicSpotCoords" placeholder="Click on map to set" readonly required>
                    </div>

                    <div class="form-group">
                        <label for="picnicPrice">Price Per Person (‚Çπ)</label>
                        <input type="number" id="picnicPrice" placeholder="e.g., 500" step="0.01" min="0" required>
                    </div>
                </div>

                <div id="mapContainer" class="map-container"></div>

                <div style="margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                    <button type="button" class="btn btn-secondary" onclick="viewMainPage()">üëÅÔ∏è View Main Page</button>
                    <a href="cashbook.html"
                        style="display: inline-block; padding: 10px 24px; background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.938rem; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4); transition: all 0.3s ease;">Cashbook</a>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.83.0/dist/umd/supabase.min.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js";

        const supabaseUrl = "https://lpvuhqtpkvbmrkhnknaf.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxwdnVocXRwa3ZibXJraG5rbmFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MDQyMDIsImV4cCI6MjA2OTI4MDIwMn0.fmKlgIAY_Yoi3sFk333lRWlxzNlNNGqRZZAuLzGLnmw";

        window.supabase = createClient(supabaseUrl, supabaseKey);

        let map;
        let busSourceMarker, picnicSpotMarker;
        let selectedMode = 'busSource'; // 'busSource' or 'picnicSpot'
        let rootConfigId = null;
        let paymentStatusMap = {}; // keyed by phone -> { name, status, timestamp, head_count, kids_count }
        let pricePerPerson = 0;
        let participants = [];

        // Initialize map
        function initMap() {
            map = L.map('mapContainer').setView([22.5726, 88.3639], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            map.on('click', function (e) {
                const lat = e.latlng.lat.toFixed(8);
                const lng = e.latlng.lng.toFixed(8);

                if (selectedMode === 'busSource') {
                    document.getElementById('busSourceCoords').value = `${lat}, ${lng}`;

                    if (busSourceMarker) {
                        map.removeLayer(busSourceMarker);
                    }
                    busSourceMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #ff6b6b; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">üöå</div>',
                            className: 'custom-marker',
                            iconSize: [32, 32]
                        })
                    }).addTo(map).bindPopup('Bus Source Point');
                } else {
                    document.getElementById('picnicSpotCoords').value = `${lat}, ${lng}`;

                    if (picnicSpotMarker) {
                        map.removeLayer(picnicSpotMarker);
                    }
                    picnicSpotMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            html: '<div style="background: #10b981; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">üìç</div>',
                            className: 'custom-marker',
                            iconSize: [32, 32]
                        })
                    }).addTo(map).bindPopup('Picnic Spot');
                }
            });
        }

        // Toggle between bus source and picnic spot selection
        document.addEventListener('DOMContentLoaded', function () {
            let pass = prompt("Enter the admin password:");
            if (pass !== "TCS_Picnic@#2026") {
                alert("Incorrect password! Redirecting to main page.");
                window.location.href = "index.html";
                return;
            }
            document.getElementById('busSourceCoords').addEventListener('click', function () {
                selectedMode = 'busSource';
                alert('Click on the map to set Bus Source coordinates');
            });

            document.getElementById('picnicSpotCoords').addEventListener('click', function () {
                selectedMode = 'picnicSpot';
                alert('Click on the map to set Picnic Spot coordinates');
            });
        });

        // Load current configuration
        async function loadConfiguration() {
            try {
                const { data, error } = await window.supabase
                    .from('picnic_2026_root')
                    .select('*')
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 is "no rows returned"
                    throw error;
                }

                if (data) {
                    rootConfigId = data.id;
                    paymentStatusMap = (data.payment_status && typeof data.payment_status === 'object') ? data.payment_status : {};
                    // Display current data
                    document.getElementById('currentData').style.display = 'block';
                    document.getElementById('currentBusSourceName').textContent = data.bus_source_name || 'Not set';
                    document.getElementById('currentBusSourceCoords').textContent =
                        data.bus_source_coordinates ? `${data.bus_source_coordinates[1]}, ${data.bus_source_coordinates[0]}` : 'Not set';
                    document.getElementById('currentPicnicSpotName').textContent = data.picnic_spot_name || 'Not set';
                    document.getElementById('currentPicnicSpotCoords').textContent =
                        data.picnic_spot ? `${data.picnic_spot[1]}, ${data.picnic_spot[0]}` : 'Not set';
                    document.getElementById('currentPrice').textContent = data.picnic_price_per_person || '0';
                    pricePerPerson = parseFloat(data.picnic_price_per_person || '0');

                    // Populate form
                    document.getElementById('busSourceName').value = data.bus_source_name || '';
                    if (data.bus_source_coordinates && data.bus_source_coordinates.length >= 2) {
                        const lat = data.bus_source_coordinates[1];
                        const lng = data.bus_source_coordinates[0];
                        document.getElementById('busSourceCoords').value = `${lat}, ${lng}`;

                        busSourceMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #ff6b6b; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">üöå</div>',
                                className: 'custom-marker',
                                iconSize: [32, 32]
                            })
                        }).addTo(map).bindPopup('Bus Source Point');
                    }

                    document.getElementById('picnicSpotName').value = data.picnic_spot_name || '';
                    if (data.picnic_spot && data.picnic_spot.length >= 2) {
                        const lat = data.picnic_spot[1];
                        const lng = data.picnic_spot[0];
                        document.getElementById('picnicSpotCoords').value = `${lat}, ${lng}`;

                        picnicSpotMarker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                html: '<div style="background: #10b981; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);">üìç</div>',
                                className: 'custom-marker',
                                iconSize: [32, 32]
                            })
                        }).addTo(map).bindPopup('Picnic Spot');

                        // Center map between both points if both exist
                        if (busSourceMarker) {
                            const bounds = L.latLngBounds([
                                [data.bus_source_coordinates[1], data.bus_source_coordinates[0]],
                                [lat, lng]
                            ]);
                            map.fitBounds(bounds, { padding: [50, 50] });
                        } else {
                            map.setView([lat, lng], 13);
                        }
                    }

                    document.getElementById('picnicPrice').value = data.picnic_price_per_person || '';
                }
            } catch (error) {
                console.error('Error loading configuration:', error);
                alert('Error loading configuration. Please refresh the page.');
            }
        }


        // Save configuration
        async function saveConfiguration(formData) {
            try {
                // Check if record exists
                const { data: existingData, error: fetchError } = await window.supabase
                    .from('picnic_2026_root')
                    .select('id')
                    .limit(1)
                    .single();

                const configData = {
                    bus_source_name: formData.busSourceName,
                    bus_source_coordinates: formData.busSourceCoords,
                    picnic_spot_name: formData.picnicSpotName,
                    picnic_spot: formData.picnicSpotCoords,
                    picnic_price_per_person: parseFloat(formData.picnicPrice),
                    updated_at: new Date().toISOString()
                };

                let result;
                if (existingData) {
                    // Update existing record
                    result = await window.supabase
                        .from('picnic_2026_root')
                        .update(configData)
                        .eq('id', existingData.id);
                } else {
                    // Insert new record
                    result = await window.supabase
                        .from('picnic_2026_root')
                        .insert([configData]);
                }

                if (result.error) throw result.error;

                alert('‚úÖ Configuration saved successfully!');
                await loadConfiguration();
            } catch (error) {
                console.error('Error saving configuration:', error);
                alert('‚ùå Error saving configuration. Please try again.');
            }
        }

        // Form submit handler
        document.getElementById('adminForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const busSourceCoords = document.getElementById('busSourceCoords').value.split(',').map(c => parseFloat(c.trim()));
            const picnicSpotCoords = document.getElementById('picnicSpotCoords').value.split(',').map(c => parseFloat(c.trim()));

            if (busSourceCoords.length !== 2 || busSourceCoords.some(isNaN)) {
                alert('Invalid Bus Source coordinates format');
                return;
            }

            if (picnicSpotCoords.length !== 2 || picnicSpotCoords.some(isNaN)) {
                alert('Invalid Picnic Spot coordinates format');
                return;
            }

            await saveConfiguration({
                busSourceName: document.getElementById('busSourceName').value,
                busSourceCoords: [busSourceCoords[1], busSourceCoords[0]], // [lng, lat]
                picnicSpotName: document.getElementById('picnicSpotName').value,
                picnicSpotCoords: [picnicSpotCoords[1], picnicSpotCoords[0]], // [lng, lat]
                picnicPrice: document.getElementById('picnicPrice').value
            });
        });

        window.viewMainPage = function () {
            window.open('index.html', '_blank');
        };

        // Initialize on load
        window.onload = async function () {
            document.getElementById('loadingOverlay').style.display = 'flex';
            initMap();
            await loadConfiguration();
            document.getElementById('loadingOverlay').style.display = 'none';
        };
    </script>
</body>

</html>